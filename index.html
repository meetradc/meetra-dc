<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meetra.to</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
body { font-family:system-ui,Arial; margin:0; color:#0f172a; }
.container { max-width:1000px; margin:auto; padding:24px; }

.user {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  margin-bottom:8px;
}
.match { border:2px solid #3259e8; background:#f0f4ff; }

button {
  padding:6px 10px;
  border-radius:8px;
  border:none;
  background:#3259e8;
  color:white;
  cursor:pointer;
}

.pending { background:#999; }
.confirm { background:#16a34a; }

.venue {
  display:flex;
  gap:10px;
  border:1px solid #e5e7eb;
  padding:10px;
  border-radius:10px;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="container">

<h2>DC Lobby</h2>

<div id="join">
  <input id="username" placeholder="Your name"><br><br>
  <input id="interest" placeholder="Interest"><br><br>
  <button onclick="join()">Join</button>
</div>

<div id="lobby" style="display:none">
  <h3>People</h3>
  <div id="users"></div>

  <div id="venues" style="display:none">
    <h3>Confirmed Venues</h3>
    <div id="venueList"></div>
  </div>
</div>

</div>

<script>
const supabaseClient = supabase.createClient(
  'https://ggirvskmmgeegjhstiqe.supabase.co',
  'sb_publishable_2iQ5bRLoZa9rlmk2m67tMw_5cgYW5H9'
);

let MY_ID, MY_INTEREST;
let poller;

/* JOIN */
async function join() {
  const u = username.value.trim();
  const i = interest.value.trim().toLowerCase();
  if (!u || !i) return alert('Missing fields');

  const { data } = await supabaseClient
    .from('profiles')
    .insert([{ username:u, interest:i }])
    .select()
    .single();

  MY_ID = data.id;
  MY_INTEREST = data.interest;

  join.style.display = 'none';
  lobby.style.display = 'block';

  load();
  poller = setInterval(load, 4000);
}

/* LOAD */
async function load() {
  const { data: people } = await supabaseClient
    .from('profiles')
    .select('id, username, interest');

  const { data: requests } = await supabaseClient
    .from('meet_requests')
    .select('*');

  users.innerHTML = '';

  people.forEach(p => {
    if (p.id === MY_ID) return;

    const isMatch = p.interest === MY_INTEREST;
    if (!isMatch) return;

    const sent = requests.find(r => r.requester_id === MY_ID && r.target_id === p.id);
    const received = requests.find(r => r.requester_id === p.id && r.target_id === MY_ID);

    const div = document.createElement('div');
    div.className = 'user match';

    let action = '';
    if (sent && received) {
      action = '<span style="color:green;font-weight:700">Confirmed</span>';
      showVenues();
    } else if (received) {
      action = `<button class="confirm" onclick="confirm(${p.id})">Confirm Meet</button>`;
    } else if (sent) {
      action = `<button class="pending" disabled>Request Sent</button>`;
    } else {
      action = `<button onclick="request(${p.id})">Letâ€™s Meet</button>`;
    }

    div.innerHTML = `<strong>${p.username}</strong>${action}`;
    users.appendChild(div);
  });
}

/* REQUEST */
async function request(targetId) {
  await supabaseClient.from('meet_requests').insert([{
    requester_id: MY_ID,
    target_id: targetId,
    interest: MY_INTEREST
  }]);
  load();
}

/* CONFIRM */
async function confirm(targetId) {
  await supabaseClient.from('meet_requests').insert([{
    requester_id: MY_ID,
    target_id: targetId,
    interest: MY_INTEREST
  }]);
  load();
}

/* VENUES */
async function showVenues() {
  venues.style.display = 'block';

  const { data } = await supabaseClient
    .from('venues')
    .select('name,address,image_url');

  venueList.innerHTML = '';
  data.forEach(v => {
    const d = document.createElement('div');
    d.className = 'venue';
    d.innerHTML = `<strong>${v.name}</strong><br>${v.address}`;
    venueList.appendChild(d);
  });
}
</script>

</body>
</html>
