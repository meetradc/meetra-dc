<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meetra.to</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:,">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
body { font-family: system-ui, Arial; margin:0; color:#0f172a; }
.container { max-width:900px; margin:auto; padding:24px; }

.card { border:1px solid #e5e7eb; border-radius:16px; padding:20px; margin-bottom:24px; }

input {
  width:100%; padding:12px; margin-bottom:10px;
  border-radius:10px; border:1px solid #e5e7eb;
}

button {
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:#3259e8;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.user {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-bottom:8px;
}

.match {
  border:2px solid #3259e8;
  background:#f0f4ff;
}

.pending { background:#9ca3af; }
.confirm { background:#16a34a; }
.locked { background:#065f46; color:white; padding:6px 10px; border-radius:8px; }

.venue {
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="container">

<h1>Meetra<span style="color:#3259e8">.to</span></h1>
<p>meet • real • now</p>

<div class="card" id="joinCard">
  <input id="usernameInput" placeholder="Your name">
  <input id="interestInput" placeholder="Interest (coffee, dog walk)">
  <button onclick="joinLobby()">Enter Lobby</button>
</div>

<div id="lobby" style="display:none">
  <h3>Matches</h3>
  <div id="userList"></div>

  <div id="venuesSection" style="display:none">
    <h3>Choose a Public Venue</h3>
    <div id="venueList"></div>
  </div>
</div>

</div>

<script>
const supabaseClient = supabase.createClient(
  'https://ggirvskmmgeegjhstiqe.supabase.co',
  'sb_publishable_2iQ5bRLoZa9rlmk2m67tMw_5cgYW5H9'
);

let MY_ID, MY_INTEREST, MATCH_ID;
let poller;

/* JOIN */
async function joinLobby() {
  const username = usernameInput.value.trim();
  const interest = interestInput.value.trim().toLowerCase();
  if (!username || !interest) return alert('Missing info');

  const { data } = await supabaseClient
    .from('profiles')
    .insert([{ username, interest }])
    .select()
    .single();

  MY_ID = data.id;
  MY_INTEREST = data.interest;

  joinCard.style.display = 'none';
  lobby.style.display = 'block';

  loadLobby();
  poller = setInterval(loadLobby, 4000);
}

/* LOAD */
async function loadLobby() {
  const { data: people } = await supabaseClient.from('profiles').select('*');
  const { data: requests } = await supabaseClient.from('meet_requests').select('*');
  const { data: votes } = await supabaseClient.from('venue_votes').select('*');

  userList.innerHTML = '';

  people.forEach(p => {
    if (p.id === MY_ID || p.interest !== MY_INTEREST) return;

    const sent = requests.find(r => r.requester_id === MY_ID && r.target_id === p.id);
    const received = requests.find(r => r.requester_id === p.id && r.target_id === MY_ID);

    let action = '';

    if (sent && received) {
      MATCH_ID = p.id;
      venuesSection.style.display = 'block';
      action = '<span class="confirm">Confirmed</span>';
      loadVenues(votes);
    } else if (received) {
      action = `<button class="confirm" onclick="confirmMeet(${p.id})">Confirm Meet</button>`;
    } else if (sent) {
      action = `<button class="pending" disabled>Request Sent</button>`;
    } else {
      action = `<button onclick="sendRequest(${p.id})">Let’s Meet</button>`;
    }

    const div = document.createElement('div');
    div.className = 'user match';
    div.innerHTML = `<strong>${p.username}</strong>${action}`;
    userList.appendChild(div);
  });
}

/* REQUESTS */
async function sendRequest(targetId) {
  await supabaseClient.from('meet_requests').insert([{
    requester_id: MY_ID,
    target_id: targetId,
    interest: MY_INTEREST
  }]);
  loadLobby();
}

async function confirmMeet(targetId) {
  await sendRequest(targetId);
}

/* VENUES */
async function loadVenues(votes) {
  const { data: venues } = await supabaseClient.from('venues').select('*');
  venueList.innerHTML = '';

  venues.forEach(v => {
    const myVote = votes.find(x =>
      x.user_id === MY_ID &&
      x.match_user_id === MATCH_ID &&
      x.venue_id === v.id
    );

    const theirVote = votes.find(x =>
      x.user_id === MATCH_ID &&
      x.match_user_id === MY_ID &&
      x.venue_id === v.id
    );

    let action = '';

    if (myVote && theirVote) {
      action = '<span class="locked">Meeting Set</span>';
    } else if (theirVote && !myVote) {
      action = `<button class="confirm" onclick="voteVenue(${v.id})">Accept</button>`;
    } else if (myVote) {
      action = `<span class="pending">Proposed</span>`;
    } else {
      action = `<button onclick="voteVenue(${v.id})">Propose</button>`;
    }

    const div = document.createElement('div');
    div.className = 'venue';
    div.innerHTML = `
      <div>
        <strong>${v.name}</strong><br>
        <small>${v.address}</small>
      </div>
      ${action}
    `;
    venueList.appendChild(div);
  });
}

/* VOTE */
async function voteVenue(venueId) {
  await supabaseClient.from('venue_votes').insert([{
    user_id: MY_ID,
    match_user_id: MATCH_ID,
    venue_id: venueId,
    interest: MY_INTEREST
  }]);
  loadLobby();
}
</script>

</body>
</html>
