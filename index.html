<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Meetra.to</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="data:,">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
body { font-family: system-ui, Arial; margin:0; color:#0f172a; }
.container { max-width: 900px; margin:auto; padding:24px; }

.card { border:1px solid #e5e7eb; border-radius:16px; padding:20px; margin-bottom:24px; }

input {
  width:100%; padding:12px; margin-bottom:10px;
  border-radius:10px; border:1px solid #e5e7eb;
}

button {
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:#3259e8;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.user {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-bottom:8px;
}

.match {
  border:2px solid #3259e8;
  background:#f0f4ff;
}

.pending { background:#9ca3af; }
.confirm { background:#16a34a; }

.venue {
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="container">

<h1>Meetra<span style="color:#3259e8">.to</span></h1>
<p>meet • real • now</p>

<div class="card" id="joinCard">
  <input id="usernameInput" placeholder="Your name">
  <input id="interestInput" placeholder="Interest (coffee, dog walk)">
  <button onclick="joinLobby()">Enter Lobby</button>
</div>

<div id="lobby" style="display:none">
  <h3>Matches</h3>
  <div id="userList"></div>

  <div id="venuesSection" style="display:none">
    <h3>Suggested Public Venues</h3>
    <div id="venueList"></div>
  </div>
</div>

</div>

<script>
const supabaseClient = supabase.createClient(
  'https://ggirvskmmgeegjhstiqe.supabase.co',
  'sb_publishable_2iQ5bRLoZa9rlmk2m67tMw_5cgYW5H9'
);

let MY_ID, MY_INTEREST;
let poller = null;

/* JOIN */
async function joinLobby() {
  const username = usernameInput.value.trim();
  const interest = interestInput.value.trim().toLowerCase();
  if (!username || !interest) return alert('Missing info');

  const { data, error } = await supabaseClient
    .from('profiles')
    .insert([{ username, interest }])
    .select()
    .single();

  if (error) return alert(error.message);

  MY_ID = data.id;
  MY_INTEREST = data.interest;

  joinCard.style.display = 'none';
  lobby.style.display = 'block';

  loadLobby();
  poller = setInterval(loadLobby, 4000);
}

/* LOAD */
async function loadLobby() {
  const { data: people } = await supabaseClient
    .from('profiles')
    .select('*');

  const { data: requests } = await supabaseClient
    .from('meet_requests')
    .select('*');

  userList.innerHTML = '';

  people.forEach(p => {
    if (p.id === MY_ID) return;
    if (p.interest !== MY_INTEREST) return;

    const sent = requests.find(r => r.requester_id === MY_ID && r.target_id === p.id);
    const received = requests.find(r => r.requester_id === p.id && r.target_id === MY_ID);

    let action = '';

    if (sent && received) {
      action = '<span style="color:#16a34a;font-weight:700">Confirmed</span>';
      showVenues();
    } else if (received) {
      action = `<button class="confirm" onclick="confirmMeet(${p.id})">Confirm Meet</button>`;
    } else if (sent) {
      action = `<button class="pending" disabled>Request Sent</button>`;
    } else {
      action = `<button onclick="sendRequest(${p.id})">Let’s Meet</button>`;
    }

    const div = document.createElement('div');
    div.className = 'user match';
    div.innerHTML = `<strong>${p.username}</strong>${action}`;
    userList.appendChild(div);
  });
}

/* SEND REQUEST */
async function sendRequest(targetId) {
  await supabaseClient.from('meet_requests').insert([{
    requester_id: MY_ID,
    target_id: targetId,
    interest: MY_INTEREST
  }]);
  loadLobby();
}

/* CONFIRM */
async function confirmMeet(targetId) {
  await supabaseClient.from('meet_requests').insert([{
    requester_id: MY_ID,
    target_id: targetId,
    interest: MY_INTEREST
  }]);
  loadLobby();
}

/* VENUES */
async function showVenues() {
  venuesSection.style.display = 'block';

  const { data } = await supabaseClient
    .from('venues')
    .select('name,address');

  venueList.innerHTML = '';
  data.forEach(v => {
    const div = document.createElement('div');
    div.className = 'venue';
    div.innerHTML = `<strong>${v.name}</strong><br>${v.address}`;
    venueList.appendChild(div);
  });
}
</script>

</body>
</html>
